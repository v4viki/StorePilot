{% extends "store/base.html" %}
{% load static %}
{% block title %}Create New Sale{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-gradient mb-0">Create New Sale</h2>
      <p class="text-muted small mb-0">Add products and complete the transaction</p>
    </div>
    <a href="{% url 'transactions:saleslist' %}" class="btn btn-outline-primary rounded-pill px-4">Go Back</a>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card soft-card shadow-sm p-3">
        <h5 class="mb-3">Sale Items</h5>

        <label class="form-label">Search / Select Item</label>
        <select id="select-item" class="form-select mb-3">
          <option value="">Select item...</option>
          {% for it in items %}
            <option value="{{ it.id }}" data-price="{{ it.price }}" data-stock="{{ it.stock }}">{{ it.text }}</option>
          {% endfor %}
        </select>

        <div class="mb-3">
          <button id="delete-all" class="btn btn-danger btn-sm">Delete All Items</button>
        </div>

        <div class="table-responsive">
          <table id="items-table" class="table align-middle modern-table">
            <thead class="table-header text-white">
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Total</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card soft-card shadow-sm p-3">
        <h5 class="mb-3">Sale Details</h5>

        <div class="mb-3">
          <label class="form-label">Customer</label>
          <select id="customer" class="form-select">
            <option value="">Select Customer</option>
            {% for c in customers %}
              <option value="{{ c.id }}">{{ c.text }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Subtotal</label>
          <input id="subtotal" readonly class="form-control" />
        </div>

        <div class="mb-2">
          <label class="form-label">Tax (%)</label>
          <input id="taxp" type="number" value="0" class="form-control" />
        </div>

        <div class="mb-2">
          <label class="form-label">Tax Amount</label>
          <input id="taxamount" readonly class="form-control" />
        </div>

        <div class="mb-2">
          <label class="form-label">Grand Total</label>
          <input id="grandtotal" readonly class="form-control" />
        </div>

        <div class="mb-2">
          <label class="form-label">Amount Paid</label>
          <input id="amount_paid" type="number" min="0" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">Change</label>
          <input id="change" readonly class="form-control" />
        </div>

        <div class="d-grid">
          <button id="submit-sale" class="btn btn-gradient rounded-pill">Save Sale</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.text-gradient { background: linear-gradient(90deg,#0ea5e9,#6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.soft-card { background: rgba(255,255,255,0.95); border-radius: 12px; }
.btn-gradient { background: linear-gradient(90deg,#0ea5e9,#6366f1); color:white; border:none; }
.table-header { background: linear-gradient(90deg,#0ea5e9,#6366f1); color: #fff; }
</style>

<script>
(function(){
  const selectItem = document.getElementById('select-item');
  const tbody = document.querySelector('#items-table tbody');
  const taxp = document.getElementById('taxp');
  const subtotalEl = document.getElementById('subtotal');
  const taxamountEl = document.getElementById('taxamount');
  const grandtotalEl = document.getElementById('grandtotal');
  const amountPaidEl = document.getElementById('amount_paid');
  const changeEl = document.getElementById('change');
  const submitBtn = document.getElementById('submit-sale');
  const deleteAllBtn = document.getElementById('delete-all');

  let items = []; // {id, text, price, quantity}

  function recalc(){
    let sub = 0;
    items.forEach(it => { sub += (it.price * it.quantity); });
    const taxPerc = parseFloat(taxp.value || 0);
    const tax = (sub * taxPerc) / 100;
    const grand = sub + tax;
    subtotalEl.value = sub.toFixed(2);
    taxamountEl.value = tax.toFixed(2);
    grandtotalEl.value = grand.toFixed(2);
    const paid = parseFloat(amountPaidEl.value || 0);
    changeEl.value = (paid - grand).toFixed(2);
  }

  function renderTable(){
    tbody.innerHTML = '';
    items.forEach((it, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${it.text}</td>
        <td>${it.price.toFixed(2)}</td>
        <td><input class="form-control form-control-sm qty-input" data-idx="${idx}" type="number" min="1" value="${it.quantity}" style="width:80px"/></td>
        <td>${(it.price * it.quantity).toFixed(2)}</td>
        <td class="text-center">
          <button data-idx="${idx}" class="btn btn-sm btn-outline-danger remove-item">Remove</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    recalc();
    attachRowListeners();
  }

  function attachRowListeners(){
    document.querySelectorAll('.remove-item').forEach(btn=>{
      btn.onclick = (ev)=>{
        const idx = parseInt(ev.target.dataset.idx,10);
        items.splice(idx,1);
        renderTable();
      }
    });
    document.querySelectorAll('.qty-input').forEach(inp=>{
      inp.onchange = (ev)=>{
        const idx = parseInt(ev.target.dataset.idx,10);
        const val = Math.max(1, parseInt(ev.target.value || 1, 10));
        items[idx].quantity = val;
        renderTable();
      }
    });
  }

  selectItem.addEventListener('change', function(){
    const val = this.value;
    if(!val) return;
    const option = this.options[this.selectedIndex];
    const id = option.value;
    const text = option.text;
    const price = parseFloat(option.dataset.price || 0);
    const existing = items.find(i=>String(i.id) === String(id));
    if(existing){
      existing.quantity += 1;
    } else {
      items.push({ id: id, text: text, price: price, quantity: 1 });
    }
    renderTable();
    this.selectedIndex = 0;
  });

  taxp.addEventListener('input', recalc);
  amountPaidEl.addEventListener('input', recalc);

  deleteAllBtn.addEventListener('click', function(e){
    e.preventDefault();
    items = [];
    renderTable();
  });

  submitBtn.addEventListener('click', function(e){
    e.preventDefault();
    if(items.length === 0){
      alert('Add at least one item');
      return;
    }

    const csrftoken = getCookie('csrftoken');
    const payload = new FormData();
    payload.append('items', JSON.stringify(items));
    payload.append('customer', document.getElementById('customer').value || '');
    payload.append('tax_percentage', taxp.value || 0);
    payload.append('amount_paid', amountPaidEl.value || 0);

    fetch("{% url 'transactions:sale-create' %}", {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'X-CSRFToken': csrftoken },
      body: payload
    }).then(response => {
      // If server redirected, follow it
      if (response.redirected) {
        window.location = response.url;
        return;
      }
      return response.text();
    }).then(txt => {
      // If response text (error), display it
      if (txt) {
        alert('Server response: ' + txt);
      }
    }).catch(err=>{
      console.error(err);
      alert('Error submitting sale. See console.');
    });
  });

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
})();
</script>
{% endblock %}
